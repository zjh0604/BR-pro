# 🚀 Locust压力测试指南

## 📋 概述

本指南介绍如何使用Locust对商业推荐系统进行压力测试，评估系统在高并发场景下的性能表现。

## 🎯 测试目标

- **推荐接口性能**：测试双推荐池在高并发下的响应时间
- **提交接口性能**：测试商单处理系统的吞吐量
- **系统稳定性**：验证系统在压力下的稳定性
- **性能瓶颈**：识别系统的性能瓶颈点

## 🛠️ 环境准备

### 1. 安装依赖

```bash
# 激活虚拟环境（如果有）
myenv\Scripts\activate

# 安装Locust依赖
pip install -r requirements_locust.txt
```

### 2. 启动测试服务器

确保FastAPI服务器正在运行：

```bash
# 启动服务器
python main.py
# 或
uvicorn main:app --host 0.0.0.0 --port 8000
```

## 🚀 启动测试

### 方法1：使用批处理脚本（推荐）

双击运行 `run_locust_test.bat`，脚本会自动：
- 检查Python环境
- 激活虚拟环境
- 安装依赖
- 启动Locust

### 方法2：命令行启动

```bash
# 基础启动
locust -f locustfile.py

# 指定目标服务器
locust -f locustfile.py --host=http://localhost:8000

# 无Web界面模式（命令行）
locust -f locustfile.py --headless --users 100 --spawn-rate 10 --run-time 5m
```

## 🌐 Web界面配置

启动后访问：http://localhost:8089

### 基础配置
- **Number of users**: 并发用户数
- **Spawn rate**: 每秒启动用户数
- **Host**: 目标服务器地址（默认：http://localhost:8000）

### 推荐配置

| 测试类型 | 并发用户数 | 启动速率 | 测试时长 | 说明 |
|---------|-----------|---------|---------|------|
| 基础测试 | 10-50 | 1用户/秒 | 5-10分钟 | 验证基本功能 |
| 中等测试 | 50-200 | 5用户/秒 | 10-20分钟 | 测试正常负载 |
| 高负载测试 | 200-1000 | 10用户/秒 | 20-30分钟 | 测试高并发性能 |
| 极限测试 | 1000+ | 20用户/秒 | 30分钟+ | 测试系统极限 |

## 📊 测试场景

### 1. 推荐接口测试（权重70%）
- 模拟用户获取推荐
- 测试不同分页参数
- 验证同城筛选功能
- 检查缓存机制效果

### 2. 提交接口测试（权重30%）
- 模拟用户提交商单
- 测试数据验证
- 验证异步处理
- 检查双推荐池生成

### 3. 推荐池状态检查（权重10%）
- 监控推荐池状态
- 验证缓存一致性
- 检查系统健康状态

## 📈 性能指标

### 响应时间
- **P50**: 50%请求的响应时间
- **P90**: 90%请求的响应时间
- **P95**: 95%请求的响应时间
- **P99**: 99%请求的响应时间

### 吞吐量
- **RPS**: 每秒请求数
- **TPS**: 每秒事务数

### 错误率
- **HTTP错误率**: 4xx/5xx错误比例
- **业务错误率**: 业务逻辑错误比例

## 🔍 结果分析

### 1. 性能报告
- 查看实时图表
- 分析响应时间分布
- 监控错误率变化

### 2. 系统监控
- CPU使用率
- 内存占用
- 网络I/O
- 数据库性能

### 3. 瓶颈识别
- 响应时间突增点
- 错误率峰值
- 系统资源饱和点

## ⚠️ 注意事项

### 1. 测试环境
- 确保测试环境与生产环境相似
- 避免在生产环境直接测试
- 准备足够的测试数据

### 2. 系统资源
- 监控服务器资源使用
- 注意数据库连接数限制
- 关注Redis内存使用

### 3. 数据安全
- 使用测试数据，避免影响生产
- 测试完成后清理测试数据
- 注意敏感信息保护

## 🐛 常见问题

### 1. 连接失败
```
❌ 连接失败: http://localhost:8000
```
**解决方案**：
- 检查FastAPI服务器是否运行
- 确认端口8000未被占用
- 检查防火墙设置

### 2. 依赖安装失败
```
❌ 依赖安装失败
```
**解决方案**：
- 升级pip: `python -m pip install --upgrade pip`
- 使用国内镜像: `pip install -i https://pypi.tuna.tsinghua.edu.cn/simple/ -r requirements_locust.txt`

### 3. 性能异常
```
❌ 响应时间异常长
```
**解决方案**：
- 检查数据库连接池
- 监控Redis性能
- 查看系统资源使用

## 📞 技术支持

如果遇到问题，请：
1. 查看控制台错误日志
2. 检查系统资源使用情况
3. 验证测试配置参数
4. 联系开发团队

## 🎉 测试完成

测试完成后，系统将生成详细的性能报告，包括：
- 响应时间统计
- 吞吐量分析
- 错误率统计
- 系统资源使用情况

这些数据将帮助评估系统是否准备好投入生产环境使用。
